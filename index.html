<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Emily’s Cat</title>
  <style>
    html, body { height:100%; margin:0; }
    body{
      background:#ffffff;                    /* white background */
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:28px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    /* Canvas */
    canvas{
      image-rendering: pixelated;
      background:#fff;
      width:256px; height:256px;             /* CSS size */
    }

    /* Buttons row */
    .buttons{ display:flex; gap:24px; }

    /* Minimal, no boxes */
    .btn{
      display:flex; align-items:center; gap:12px;
      background:transparent; border:none; padding:0;
      color:#111; font-size:28px; cursor:pointer;
      user-select:none;
    }
    .btn img{ image-rendering: pixelated; display:block; }

    /* icon sizes (vodka 5x kimchi) */
    .icon-kimchi{ width:40px; height:auto; }
    .icon-vodka { width:200px; height:auto; } /* ~5× */
  </style>
</head>
<body>

  <!-- Game area -->
  <canvas id="game" width="256" height="256" aria-label="Emily's cat"></canvas>

  <!-- Buttons -->
  <div class="buttons">
    <button id="btnKimchi" class="btn" title="Kimchi">
      <img class="icon-kimchi" src="KImchi.png" alt="Kimchi">
      Kimchi
    </button>

    <button id="btnVodka" class="btn" title="Vodka">
      <img class="icon-vodka" src="vodka.png" alt="Vodka">
      Vodka
    </button>
  </div>

  <script>
    // ====== settings ======
    const FRAME_W = 64, FRAME_H = 64;    // each frame size
    const FPS = 4;                       // slower animation
    const CANVAS_SIZE = 256;             // canvas is 256x256
    const SCALE = CANVAS_SIZE / FRAME_W; // 4x scale
    // ======================

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: false });
    ctx.imageSmoothingEnabled = false;

    // Sprite sheets (auto-calc frames from image width)
    const SHEETS = {
      idle:           { src: 'NormalIdle.png' },              // default loop
      sickIdle:       { src: 'sixkidle2.png' },               // sick loop
      kimchi:         { src: 'normalkimchinormal.png', once:true, heal:true },
      vodka:          { src: 'normalvodkasick.png',  once:true, makeSick:true }
    };

    // simple image cache
    const cache = new Map();
    function getImg(src){
      return new Promise((resolve, reject)=>{
        if (cache.has(src)) return resolve(cache.get(src));
        const img = new Image();
        img.onload = ()=>{ cache.set(src, img); resolve(img); };
        img.onerror = reject;
        img.src = src;
      });
    }

    // state
    let baseline = 'idle';      // 'idle' or 'sickIdle'
    let current  = null;        // currently playing sheet key
    let frame = 0;
    let totalFrames = 1;
    let lastTime = 0;
    let playingOnce = false;
    let img = null;

    async function play(key){
      current = key;
      const sheet = SHEETS[key];
      img = await getImg(sheet.src);
      totalFrames = Math.max(1, Math.floor(img.width / FRAME_W)); // auto-detect
      frame = 0;
      playingOnce = !!sheet.once;
    }

    function setHealthy(){ baseline = 'idle'; }
    function setSick(){ baseline = 'sickIdle'; }

    async function doKimchi(){
      await play('kimchi');
      // on finish -> healthy idle
      onFinish = ()=>{ setHealthy(); play(baseline); };
    }

    async function doVodka(){
      await play('vodka');
      // on finish -> sick idle
      onFinish = ()=>{ setSick(); play(baseline); };
    }

    // draw loop with FPS throttle
    let onFinish = null;
    function loop(ts){
      requestAnimationFrame(loop);

      if (!img) return;

      // throttle to FPS
      if (ts - lastTime < 1000 / FPS) return;
      lastTime = ts;

      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // source frame rect
      const sx = frame * FRAME_W;
      const sy = 0;

      // dest centered
      const dx = Math.floor((canvas.width  - FRAME_W * SCALE) / 2);
      const dy = Math.floor((canvas.height - FRAME_H * SCALE) / 2);

      ctx.drawImage(
        img,
        sx, sy, FRAME_W, FRAME_H,
        dx, dy, FRAME_W * SCALE, FRAME_H * SCALE
      );

      frame++;

      if (frame >= totalFrames) {
        if (playingOnce) {
          playingOnce = false;
          // finish the one-shot, then go baseline
          if (typeof onFinish === 'function') { const f = onFinish; onFinish = null; f(); }
        } else {
          frame = 0; // loop
        }
      }
    }

    // wire buttons
    document.getElementById('btnKimchi').addEventListener('click', doKimchi);
    document.getElementById('btnVodka').addEventListener('click', doVodka);

    // boot: start normal idle loop
    (async () => {
      await play(baseline);
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
